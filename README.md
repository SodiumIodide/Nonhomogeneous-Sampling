# Nonhomogeneous Sampling

Methods of nonhomogeneous Poisson sampling for generic neutral particle transport in one dimension. Includes methodology for both linearly and quadratically varying material chord lengths within a finite domain.

## Requirements

- **CMake**
    - As a build tool, but with some configuration file editing this can be avoided.
- **LAPACK**
    - For the analytical solution to the system. The code currently assumes a column-major array accessing scheme utilized by this library.

### Python and Visualization

Python 3 is used with Matplotlib as a dependency for visualization purposes. Numpy is used for data manipulation, and Pandas is used for CSV input.

Inside the `/check` directory there also exists an analytical solution for the material volume fractions written in Python 3 as a benchmark.

## Usage

Changing code performance involves recompiling the code. Compilation time is reduced by avoiding linking unnecessary header files for options set. Performance changes are affected largely by two files: `src/CMakeLists.txt` and `src/constants.h`

A typical rebuild is exemplified in the `compile_run_program.sh` file, using generic commands in a standard Bash environment.

### CMakeLists.txt

The `CMakeLists.txt` file contains much of the user-selected variables in terms of program flow. By editing the options highlighted in this file, different compile-time constraints are set and the code will evaluate the problems differently.

The file will default to using a direct sampling, continuous linearly varying chord length model, pure absorber physics solution.

Available options:
- **REJECTION**
    - The code will change to sampling via thinning or a "rejection"-based method for building the geometry realizations. This will override the direct sampling default.
- **QUADRATIC**
    - The code will change to a quadratically varying chord length model. Details on local minima/maxima are described below. This will override the linearly varying chord length model default.
- **PIECEWISE**
    - The chord lengths will be represented as an equidistant piecewise constant function mapped onto the continuously varying model. The number of piecewise constant segments is changeable within the `constants.h` header file. This will override the continuous function default.

Available solution types (only one may be used at a time). These will override the default pure absorber physics behavior:
- **S2**
    - The solution will be an S2 model that relies on diamond-differencing the grid generated by geometry realization. The error tolerance for convergence may be altered within the `constants.h` header file.
- **GEOMETRYTIME**
    - Using volatile inline assembly to limit compiler optimization, a number of geometry realizations will be generated, and the CPU cycles per generation counted via the ASM `RDTSC` operation.
- **ANALYTICAL**
    - A matrix solution to the one-dimensional transport equation. This option requires access to a LAPACK library for the `dgesv` routine.
- **VOLFRAC**
    - The solution files generated will not contain material-average scalar fluxes, but will contain material volume fraction values. This is largely the same statistical computation, but scalar flux solutions are assumed unity and zero-value terms are included in averaging.


### constants.h

Other useful parameters to change are included in this file. Comments are present to describe variables used. A listing is tabulated below:

| Variable | Description |
| --- | --- |
| `SEED` | Integral seed number for using the compiler-defined random number generator included in `stdlib.h` |
| `NUM_ORDS` | Number of ordinates in an SN solution. Default and tested value is 2 |
| `START_VALUE` | Array containing the chord length values at the left-hand problem boundary, defined as the x-axis origin |
| `END_VALUE` | Array containing the chord length values at the right-hand problem boundary |
| `END_DIST` | The x-axis location of the right-hand problem boundary, or the total x-length of the problem |
| `SIGMA_T` | Array containing the total macroscopic cross-section values of each material |
| `SCAT_COEFF` | Array containing the scattering ratio values of each material: defined as the scattering cross-section divided by the total cross-section |
| `SPONT_SOURCE_CONST` | Array containing the source strength of a distributed volumetric source within each material; only involved in the SN solution methodology |
| `NUM_SEGMENTS` | Number of representative fit and equidistant segments mapped onto a continuous function when using the piecewise constant solution - note that there are ray effects present at piecewise constant interfaces in the problem, so a larger number may be desired |
| `INCIDENT_ANGULAR_FLUX` | Boundary condition at the left-hand side of the problem - incident angular flux counter to the problem normal (entering domain) - positive x-direction |
| `REVERSE_ANGULAR_FLUX` | Boundary condition at the right-hand side of the problem - incident angular flux counter to the problem normal (entering domain) - negative x-direction |
| `FLUX_INIT` | Pure absorber solution only - scalar flux boundary condition at the left-hand side of the problem, exponentially attenuated through material regions |
| `NUM_TIME` | Geometry timing solution only - number of geometries to generate when tallying CPU cycles consumed |
| `NUM_REALIZATIONS` | Total number of realizations to create while averaging scalar flux data |
| `NUM_SAY` | When running in terminal, a progress message is displayed for every `NUM_SAY` completed realizations |
| `TOLERANCE` | The relative error tolerance for convergence testing when using diamond differencing in the SN solution |

## Note on Quadratic Chord Length Variation

There is no methodology developed for directly sampling the continuous quadratic chord length functions. The thinning algorithm is required for these geometry generation parameters.

The local maxima and minima are determined by setting a local maxima in material 0 as twice the largest endpoint value and a local minima in material 1 as half the smallest endpoint value, with specific constraints imposed on the governing quadratic equation.

## Note on Parallelism

***The code as it stands is fully serial***. Sorry for any inconvenience this poses. The caveat to this is when using the analytical solution methodology, as depending on the LAPACK libraries found, the subroutine call to `dgesv` may implement multithreaded computation.

No effort was made for parallel performance. Theory is known on collapsing multiple statistical sets and preserving variance, and such methods have been implemented by the author previously in a CUDA domain. Due to the number of solution methodologies present in this system and the differing quantities of data stored per geometry realization, parallelism is at this point considered outside the scope of the code domain. This may change in the future, but will likely incur additional dependencies such as an MPI framework or a newer C standard.
